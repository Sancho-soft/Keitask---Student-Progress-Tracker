rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.role;
    }

    function isProfessor() {
      return isSignedIn() && getUserRole(request.auth.uid) == 'professor';
    }

    match /tasks/{taskId} {
      allow read: if isSignedIn();

      // Create: only authenticated users; creator must be request.auth.uid
      allow create: if isSignedIn() && request.resource.data.creator == request.auth.uid;

      // Update: enforce allowed transitions and roles
      allow update: if isSignedIn() && (
        // Admin OR Professor can update any task (grading, status, etc)
        // Ideally we'd restrict Professors to only tasks they created, but simple role check is safer for now
        isAdmin() || isProfessor()
        ||
        // Assignee can resubmit when rejected, and complete when pending/resubmitted
        ((resource.data.assignee == request.auth.uid || resource.data.assignees.hasAny([request.auth.uid])) && (
          // Status transitions
          (resource.data.status == 'rejected' && request.resource.data.status == 'resubmitted') ||
          (resource.data.status in ['pending', 'resubmitted'] && request.resource.data.status == 'completed') ||
          // Allow edits to submissions/notes WITHOUT changing status (e.g. adding files)
          (resource.data.status == request.resource.data.status && 
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['submissions', 'notes', 'submissionNotes', 'completionStatus']))
        ))
      );

      // Only admin or professor can delete tasks
      allow delete: if isAdmin() || isProfessor();
    }

    // Users collection: users can read, a user can update their own profile
    match /users/{userId} {
      allow read: if isSignedIn();
      // Allow update if own profile OR if Admin/Professor (for points/grading)
      allow update: if request.auth != null && (
        request.auth.uid == userId || isAdmin() || isProfessor()
      );
      allow create: if request.auth != null && request.auth.uid == userId;
    }
  }
}
